import{T as y,bc as E,W as S,bd as A,f as C,be as H,bf as x,c as h,X as s}from"#entry";import{u as I}from"./BtEvuF_g.js";function p(e){return e.length>1&&e.slice(-1)==="/"?e.slice(0,-1):e}const U=()=>{const e=y(),i=E(),c=I(),t=S(),a=A(),u=C(()=>i.value!==null),w=H(x,()=>!1);async function k(){w.value||(w.value=!0,await d(),await e.callHook("sanctum:init"))}async function d(){i.value=await c(t.endpoints.user),await e.callHook("sanctum:refresh")}async function v(l,f=!0){const o=h(),g=p(o.path);if(u.value){if(!t.redirectIfAuthenticated)throw new Error("User is already authenticated");if(t.redirect.onLogin===!1||t.redirect.onLogin===g)return;if(t.redirect.onLogin===void 0)throw new Error("`sanctum.redirect.onLogin` is not defined");const n=t.redirect.onLogin;await e.callHook("sanctum:redirect",n),await e.runWithContext(async()=>await s(n))}if(t.endpoints.login===void 0)throw new Error("`sanctum.endpoints.login` is not defined");const r=await c(t.endpoints.login,{method:"post",body:l});if(t.mode==="token"){if(a.tokenStorage===void 0)throw new Error("`sanctum.tokenStorage` is not defined in app.config.ts");if(r.token===void 0)throw new Error("Token was not returned from the API");await a.tokenStorage.set(e,r.token)}if(f&&await d(),await e.callHook("sanctum:login"),t.redirect.keepRequestedRoute){const n=o.query.redirect;if(n&&n!==g)return await e.callHook("sanctum:redirect",n),await e.runWithContext(async()=>await s(n)),r}if(t.redirect.onLogin===!1||o.path===t.redirect.onLogin)return r;if(t.redirect.onLogin===void 0)throw new Error("`sanctum.redirect.onLogin` is not defined");const m=t.redirect.onLogin;return await e.callHook("sanctum:redirect",m),await e.runWithContext(async()=>await s(m)),r}async function L(){if(!u.value)throw new Error("User is not authenticated");const l=h(),f=p(l.path);if(t.endpoints.logout===void 0)throw new Error("`sanctum.endpoints.logout` is not defined");if(await c(t.endpoints.logout,{method:"post"}),i.value=null,await e.callHook("sanctum:logout"),t.mode==="token"){if(a.tokenStorage===void 0)throw new Error("`sanctum.tokenStorage` is not defined in app.config.ts");await a.tokenStorage.set(e,void 0)}if(t.redirect.onLogout===!1||f===t.redirect.onLogout)return;if(t.redirect.onLogout===void 0)throw new Error("`sanctum.redirect.onLogout` is not defined");const o=t.redirect.onLogout;await e.callHook("sanctum:redirect",o),await e.runWithContext(async()=>await s(o))}return{user:i,isAuthenticated:u,init:k,login:v,logout:L,refreshIdentity:d}};export{p as t,U as u};
